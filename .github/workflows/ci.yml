name: Merged Build & Release

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# âš¡ Concurrency: Cancels the entire job if a new push comes in.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  android-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Inject Google Services
        env:
          GOOGLE_SERVICES_API_KEY: ${{ secrets.GOOGLE_SERVICES_API_KEY }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
        run: |
          if [ -f "app/google-services.json.template" ]; then
            echo "Template found. Injecting secrets..."
            sed -e 's/{{\([^}]*\)}}/${\1}/g' app/google-services.json.template | envsubst > app/google-services.json
          else
            echo "Warning: google-services.json.template not found. Skipping injection."
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        id: gradle-build
        run: |
          set +e
          export BUILD_NUMBER=$(git rev-list --count HEAD)
          
          # Build the APK
          ./gradlew assembleDebug -PversionBuild=$BUILD_NUMBER --build-cache > build.log 2>&1
          
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          cat build.log
          exit $EXIT_CODE

      - name: Report Failure to Jules
        if: failure() && steps.gradle-build.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let logTail = 'Log file not found.';
            try { logTail = fs.readFileSync('build.log', 'utf8').slice(-4000); } catch (e) {}
            
            const assignee = 'gemini-code-assist';
            
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Build Failure on ${context.eventName === 'pull_request' ? 'PR #' + context.issue.number : context.ref}`,
                body: `@${assignee} /jules debug this build error\n\n**Log:**\n\`\`\`\n${logTail}\n\`\`\``,
                labels: ['jules', 'bug'],
                assignees: [assignee]
              });
            } catch (error) {
              console.log("Failed to create issue with assignee. Retrying without assignee.");
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Build Failure on ${context.eventName === 'pull_request' ? 'PR #' + context.issue.number : context.ref}`,
                body: `@${assignee} /jules debug this build error\n\n**Log:**\n\`\`\`\n${logTail}\n\`\`\``,
                labels: ['jules', 'bug']
              });
            }

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk

  web-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.51
          actions-cache-folder: 'emsdk-cache'

      - name: Build OpenCV for Wasm
        run: |
          chmod +x scripts/build_opencv_wasm.sh
          ./scripts/build_opencv_wasm.sh

      - name: Verify Web Build
        run: |
          mkdir -p web_lib/build
          cd web_lib/build
          emcmake cmake .. -DOPENCV_DIR=../../libs/opencv-wasm
          emmake make

  release:
    needs: android-build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug

      - name: Prepare Release Variables
        id: release_vars
        run: |
          export BUILD_NUMBER=$(git rev-list --count HEAD)
          
          # Extract version info from properties file
          MAJOR=$(grep 'versionMajor=' version.properties | cut -d'=' -f2)
          MINOR=$(grep 'versionMinor=' version.properties | cut -d'=' -f2)

          # Calculate Patch version programmatically based on commits since Minor update
          MINOR_COMMIT=$(git blame -L '/versionMinor=/',+1 version.properties | awk '{print $1}' | tr -d '^')
          if [ -n "$MINOR_COMMIT" ]; then
            PATCH=$(git rev-list --count $MINOR_COMMIT..HEAD)
          else
            PATCH=$(grep 'versionPatch=' version.properties | cut -d'=' -f2)
          fi

          VERSION_NAME="$MAJOR.$MINOR.$PATCH.$BUILD_NUMBER"
          
          TAG_NAME="v$VERSION_NAME"
          
          # Dynamic App Name from settings.gradle
          if [ -f "settings.gradle.kts" ]; then
             APP_NAME=$(grep 'rootProject.name' settings.gradle.kts | sed -E "s/.*=.*[\"'](.*)[\"']/\1/")
          elif [ -f "settings.gradle" ]; then
             APP_NAME=$(grep 'rootProject.name' settings.gradle | sed -E "s/.*=.*[\"'](.*)[\"']/\1/")
          else
             APP_NAME="App"
          fi
          
          # Locate built APK
          APK_ORIGINAL=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          
          if [ -z "$APK_ORIGINAL" ]; then
             echo "Error: No APK found to release!"
             exit 1
          fi

          TARGET_NAME="${APP_NAME}-${VERSION_NAME}-debug.apk"
          
          # Rename for release
          mv "$APK_ORIGINAL" "$TARGET_NAME"
          
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "APK_FILE=$TARGET_NAME" >> $GITHUB_ENV
          
          # Package Build Tools (Optional)
          # Note: We need to reconstruct this part or upload these as artifacts too if we want them in release.
          # The previous job "android-build" had access to src/main/assets and jniLibs.
          # "release" job has checked out source, so it has assets.
          # But it doesn't have the built native libs unless we build them or download them.
          # The jniLibs in app/src/main/jniLibs are pre-built or source?
          # If they are source, we have them. If they are build output, we don't.
          # The script copies from "app/src/main/jniLibs/arm64-v8a". This is usually where imported libs are.
          # So checking out source should be enough if they are committed.
          # If they are generated during build, we miss them.
          # Assuming they are in source control or fetched.

          mkdir -p build_tools_package/tools build_tools_package/native
          [ -d "app/src/main/assets/tools" ] && cp -r app/src/main/assets/tools/* build_tools_package/tools/ || true
          [ -d "app/src/main/jniLibs/arm64-v8a" ] && cp -r app/src/main/jniLibs/arm64-v8a/* build_tools_package/native/ || true
          cd build_tools_package && zip -r ../build-tools.zip . && cd ..

      - name: Publish Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Clean up existing tag/release to allow re-runs
          echo "Checking for existing release/tag..."
          gh release delete $TAG_NAME -y --cleanup-tag || echo "No existing release to delete."
          git tag -d $TAG_NAME || echo "No local tag to delete."
          git push origin --delete $TAG_NAME || echo "No remote tag to delete."

          # Create unique tag for this build
          git tag -a $TAG_NAME -m "Debug Build $VERSION_NAME"
          git push origin $TAG_NAME

          BUILD_TOOLS="build-tools.zip"

          echo "Creating new release for $TAG_NAME..."
          gh release create $TAG_NAME "$APK_FILE" --prerelease \
            --title "Debug Build $VERSION_NAME" \
            --notes "Auto-build from commit $GITHUB_SHA" \
            --target $GITHUB_SHA

          [ -f "$BUILD_TOOLS" ] && gh release upload $TAG_NAME "$BUILD_TOOLS"
