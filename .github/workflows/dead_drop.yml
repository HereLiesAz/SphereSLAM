name: "Context Backup (Standard Artifact)"

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Clean Context
        shell: bash
        run: |
          # --- CONFIGURATION ---
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          OUTFILE="project_backup_full_${TIMESTAMP}.txt"
          
          # TRASH FILTERS (Files/Dirs to ignore)
          TRASH_DIRS="build out bin obj .gradle .idea .vscode .git node_modules captures .cxx generated"
          TRASH_FILES="package-lock.json yarn.lock local.properties .DS_Store Thumbs.db"

          echo -e "\033[36m[+] Generating Context...\033[0m"
          touch "$OUTFILE"

          # Helper: Check for binary
          is_binary() {
              if head -c 512 "$1" | grep -qP '\x00'; then return 0; else return 1; fi
          }

          # 1. FIND FILES
          if [ -d ".git" ]; then
              FILES=$(git ls-files -c -o --exclude-standard)
          else
              FILES=$(find . -type f)
          fi

          # 2. PROCESS FILES
          echo "$FILES" > filelist.tmp
          while IFS= read -r file; do
              # Skip Trash Directories
              SKIP=0
              for trash in $TRASH_DIRS; do
                  if [[ "$file" == *"/$trash/"* ]] || [[ "$file" == "$trash/"* ]] || [[ "$file" == *"/$trash" ]]; then
                      SKIP=1; break
                  fi
              done
              # Skip Trash Files
              BASENAME=$(basename "$file")
              for trash in $TRASH_FILES; do
                  if [[ "$BASENAME" == "$trash" ]]; then SKIP=1; break; fi
              done
              
              if [[ "$SKIP" -eq 1 ]]; then continue; fi
              
              # Write Content
              echo ">>> $file" >> "$OUTFILE"
              if is_binary "$file"; then
                  echo "[BINARY CONTENT SKIPPED]" >> "$OUTFILE"
              else
                  cat "$file" >> "$OUTFILE" 2>>/dev/null || echo "[READ ERROR]" >> "$OUTFILE"
              fi
              echo -e "\n\n" >> "$OUTFILE"
          done < filelist.tmp
          rm filelist.tmp

          echo "BACKUP_FILE=$OUTFILE" >> $GITHUB_ENV
          echo -e "\033[32m[+] Complete: $OUTFILE\033[0m"

      - name: Upload to Artifacts Tab
        uses: actions/upload-artifact@v4
        with:
          name: context-backup
          path: ${{ env.BACKUP_FILE }}
          retention-days: 1
